---
import MainGridLayout from "../layouts/MainGridLayout.astro";
import { links } from "../config/friend";
import { momentsData } from "../config/moment";
import { postData } from "../config/posts";
import { Icon } from "astro-icon/components";
import { siteConfig } from "../config";

const dashboardTopItems = [
  {
    title: "文章",
    icon: "material-symbols:folder-outline-rounded",
    content: postData.length,
    key: "posts",
  },
  {
    title: "动态",
    icon: "material-symbols:calendar-today-outline",
    content: momentsData.length,
    key: "moments",
  },
  {
    title: "友链",
    icon: "material-symbols:link-rounded",
    content: links.length,
    key: "friends",
  },
];

function getTotalCharCount(posts: typeof postData): number {
  return posts.reduce((sum, post) => {
    if (!post.content) return sum;

    let count = 0;
    for (const char of post.content) {
      if (/[\u4e00-\u9fff]/.test(char)) {
        // 中文按 1 个字
        count += 1;
      } else if (/[a-zA-Z0-9]/.test(char)) {
        // 英文和数字按 2 个算 1 个字
        count += 0.5;
      } else {
        // 其他符号按 0.5 个算 1 个字
        count += 0.5;
      }
    }

    return sum + count;
  }, 0);
}

// 计算距今天最近更新天数
function getDaysSinceLastUpdate(posts: typeof postData): number {
  if (!posts.length) return 0;
  const latest = posts
    .map((p) => new Date(p.published).getTime())
    .reduce((a, b) => Math.max(a, b));
  const now = Date.now();
  return Math.floor((now - latest) / (1000 * 60 * 60 * 24));
}

// 计算平均更新频率（单位：天）
function getUpdateFrequency(posts: typeof postData): number {
  if (posts.length < 2) return 0;
  const sorted = posts
    .map((p) => new Date(p.published).getTime())
    .sort((a, b) => a - b);

  let totalDiff = 0;
  for (let i = 1; i < sorted.length; i++) {
    totalDiff += sorted[i] - sorted[i - 1];
  }
  const avgDiffMs = totalDiff / (sorted.length - 1);
  return Math.round(avgDiffMs / (1000 * 60 * 60 * 24));
}

function getDaysSinceFirstUpdate(posts: typeof postData): number {
  if (!posts.length) return 0;
  const firstDate = new Date(
    Math.min(...posts.map((p) => new Date(p.published).getTime()))
  );
  const now = new Date();
  const diffMs = now.getTime() - firstDate.getTime();
  return Math.floor(diffMs / (1000 * 60 * 60 * 24));
}

const postContent = [
  {
    title: "字数",
    icon: "material-symbols:text-snippet-outline-rounded",
    content: getTotalCharCount(postData),
    key: "posts",
  },
  {
    title: "距上次更新",
    icon: "material-symbols:calendar-clock-outline-rounded",
    content: getDaysSinceLastUpdate(postData) + "d",
    key: "lastUpdate",
  },
  {
    title: "平均更新频率",
    icon: "material-symbols:edit-calendar-outline-rounded",
    content: getUpdateFrequency(postData) + "d",
    key: "updateFrequency",
  },
  {
    title: "距离第一次更新",
    icon: "material-symbols:calendar-month-outline-rounded",
    content: getDaysSinceFirstUpdate(postData) + "d",
    key: "firstUpdate",
  },
];

const sortedPosts = [...postData].sort(
  (a, b) => new Date(b.published).getTime() - new Date(a.published).getTime()
);
const sortedMoments = [...momentsData].sort(
  (a, b) =>
    new Date(`${b.date}T${b.time}`).getTime() -
    new Date(`${a.date}T${a.time}`).getTime()
);
const sortedLinks = [...links].sort((a, b) =>
  a.fileName.localeCompare(b.fileName)
);

function getTimeString(): string {
  const now = new Date();
  const parts = new Intl.DateTimeFormat("zh-CN", {
    timeZone: "Asia/Shanghai",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false,
  }).formatToParts(now);

  const get = (type: string) =>
    parts.find((p) => p.type === type)?.value ?? "00";

  return `${get("year")}${get("month")}${get("day")}_${get("hour")}${get("minute")}`;
}

function getDate(): string {
  const now = new Date();
  const parts = new Intl.DateTimeFormat("zh-CN", {
    timeZone: "Asia/Shanghai",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).formatToParts(now);

  const get = (type: string) =>
    parts.find((p) => p.type === type)?.value ?? "00";

  return `${get("year")}-${get("month")}-${get("day")}`;
}

// 测试
console.log(getTimeString()); // 20250914_1955
console.log(getDate()); // 2025-09-14

const postFileTemplate = `---
title:
published: ${getDate()}
description: 
tags: []
category: 
origin: ""
image: ""
pinned: false
draft: false
---`;

const friendFileTemplate = `{
  "title": "",
  "link": "",
  "desc": "",
  "img": ""
}`;

const momentFileTemplate = `{
  "date": "${getDate()}",
  "time": "${String(new Date().getHours()).padStart(2, "0")}:${String(new Date().getMinutes()).padStart(2, "0")}",
  "content": ""
}`;
---

<MainGridLayout title="仪表盘" description="网页信息一览">
  <!-- Top statistics buttons -->
  <div
    id="dashboard-tabs"
    class="flex flex-col sm:flex-row w-full overflow-hidden relative card-base px-9 py-6 mb-4"
  >
    {
      dashboardTopItems.map((item, index) => (
        <>
          <button
            data-tab={item.key}
            class={`flex items-center w-full sm:flex-1 mb-0 cursor-pointer opacity-60`}
          >
            <Icon
              name={item.icon}
              class="w-6 h-6 text-neutral-900 dark:text-neutral-100"
            />
            <div class=" text-neutral-900 dark:text-neutral-100 ml-3 font-semibold">
              {item.title}
            </div>
            <div class=" text-neutral-400 dark:text-neutral-600 ml-auto">
              {item.content}
            </div>
          </button>
          {index !== dashboardTopItems.length - 1 && (
            <div class="sm:border-l-[1px] border-t-[1px] border-dashed border-black/10 dark:border-white/[0.15] mx-0 my-4 sm:mx-6 sm:my-0" />
          )}
        </>
      ))
    }
  </div>

  <!-- Articles section -->
  <div
    id="tab-posts"
    class="tab-section card-base z-10 px-9 py-6 relative w-full flex flex-col gap-3.5 mb-4"
  >
    <div class="flex items-center">
      <span class="text-neutral-900 dark:text-neutral-100 font-semibold"
        >文章</span
      >
      <a
        class="p-1 rounded-md ml-auto transition-colors"
        href={`https://github.com/${siteConfig.editPost.repo}/new/main/src/content/posts?filename=${getTimeString()}.md&value=${encodeURIComponent(postFileTemplate)}`}
      >
        <Icon
          name="material-symbols:new-window-rounded"
          class="text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300 transition-all"
        />
      </a>
    </div>
    <div
      class="transition border-t-[1px] border-dashed border-black/10 dark:border-white/[0.15]"
    >
    </div>

    {/* Loop through posts */}
    {
      sortedPosts.map((post) => (
        <div class="flex items-center">
          <span class="text-neutral-700 dark:text-neutral-300 font-semibold overflow-hidden whitespace-nowrap text-ellipsis pr-10">
            {post.title}
          </span>

          <a
            class="p-1 rounded-md ml-auto transition-colors"
            href={`${siteConfig.domain[0]}${post.url}`}
          >
            <Icon
              name="fluent:open-12-regular"
              class="text-gray-500 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-all"
            />
          </a>
          <a
            class="p-1 rounded-md ml-2 transition-colors"
            href={`https://github.com/${siteConfig.editPost.repo}/edit/main/src/content${post.url}.md`}
          >
            <Icon
              name="fluent:edit-12-regular"
              class="text-gray-500 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-all"
            />
          </a>
          <a
            class="p-1 rounded-md ml-2 transition-colors"
            href={`https://github.com/${siteConfig.editPost.repo}/delete/main/src/content${post.url}.md`}
          >
            <Icon
              name="fluent:delete-12-regular"
              class="text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300 transition-all"
            />
          </a>
        </div>
      ))
    }
  </div>

  <div
    id="tab-posts"
    class="tab-section card-base z-10 px-9 py-6 relative w-full flex flex-col gap-3.5 mb-4"
  >
    {
      postContent.map((item) => (
        <>
          <div class="flex">
            <Icon
              name={item.icon}
              class="relative top-[3px] mr-3 text-neutral-700 dark:text-neutral-300 transition-all"
            />
            <div class="font-semibold text-neutral-700 dark:text-neutral-300 transition-all">
              {item.title}
            </div>
            <div class="ml-auto text-neutral-500 dark:text-neutral-500 transition-all">
              {item.content}
            </div>
          </div>
        </>
      ))
    }
  </div>

  <!-- Friends section -->
  <div
    id="tab-friends"
    class="tab-section card-base z-10 px-9 py-6 relative w-full flex flex-col gap-3.5 mb-4"
    style="display:none;"
  >
    <div class="flex items-center">
      <span class="text-neutral-900 dark:text-neutral-100 font-semibold"
        >友链</span
      >
      <a
        class="p-1 rounded-md ml-auto transition-colors"
        href={`https://github.com/${siteConfig.editPost.repo}/new/main/src/config/friends?filename=${getTimeString()}.json&value=${encodeURIComponent(friendFileTemplate)}`}
      >
        <Icon
          name="material-symbols:new-window-rounded"
          class="text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300 transition-all"
        />
      </a>
    </div>
    <div
      class="transition border-t-[1px] border-dashed border-black/10 dark:border-white/[0.15]"
    >
    </div>

    {/* Loop through friends */}
    {
      sortedLinks.map((link) => (
        <div class="flex items-center">
          <span class="text-neutral-700 dark:text-neutral-300 font-semibold overflow-hidden whitespace-nowrap text-ellipsis">
            {link.title}
          </span>
          <span class="ml-3 text-neutral-400 dark:text-neutral-500 hidden md:block overflow-hidden whitespace-nowrap text-ellipsis pr-10">
            {link.desc}
          </span>
          <a
            class="p-1 rounded-md ml-auto transition-colors"
            href={`${link.link}`}
          >
            <Icon
              name="fluent:open-12-regular"
              class="text-gray-500 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-all"
            />
          </a>
          <a
            class="p-1 rounded-md ml-2 transition-colors"
            href={`https://github.com/${siteConfig.editPost.repo}/edit/main/src/config/friends/${link.fileName}`}
          >
            <Icon
              name="fluent:edit-12-regular"
              class="text-gray-500 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-all"
            />
          </a>
          <a
            class="p-1 rounded-md ml-2 transition-colors"
            href={`https://github.com/${siteConfig.editPost.repo}/delete/main/src/config/friends/${link.fileName}`}
          >
            <Icon
              name="fluent:delete-12-regular"
              class="text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300 transition-all"
            />
          </a>
        </div>
      ))
    }
  </div>

  <!-- Moments section -->
  <div
    id="tab-moments"
    class="tab-section card-base z-10 px-9 py-6 relative w-full flex flex-col gap-3.5"
    style="display:none;"
  >
    <div class="flex items-center">
      <span class="text-neutral-900 dark:text-neutral-100 font-semibold"
        >动态</span
      >
      <a
        class="p-1 rounded-md ml-auto transition-colors"
        href={`https://github.com/${siteConfig.editPost.repo}/new/main/src/config/moments?filename=${getTimeString()}.json&value=${encodeURIComponent(momentFileTemplate)}`}
      >
        <Icon
          name="material-symbols:new-window-rounded"
          class="text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300 transition-all"
        />
      </a>
    </div>
    <div
      class="transition border-t-[1px] border-dashed border-black/10 dark:border-white/[0.15]"
    >
    </div>

    {/* Loop through moments */}
    {
      sortedMoments.map((m) => (
        <div class="flex items-center">
          <span class="text-neutral-700 dark:text-neutral-300 font-semibold overflow-hidden whitespace-nowrap text-ellipsis pr-10">
            {m.content}
          </span>
          <button
            class="p-1 rounded-md ml-auto transition-colors"
            onclick="navigator.clipboard.writeText(this.dataset.content).then(()=>console.log('Copied!'))"
            data-content={m.content}
          >
            <Icon
              name="fluent:copy-16-regular"
              class="text-gray-500 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-all"
            />
          </button>
          <a
            class="p-1 rounded-md ml-2 transition-colors"
            href={`https://github.com/${siteConfig.editPost.repo}/edit/main/src/config/moments/${m.fileName}`}
          >
            <Icon
              name="fluent:edit-12-regular"
              class="text-gray-500 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-all"
            />
          </a>
          <a
            class="p-1 rounded-md ml-2 transition-colors"
            href={`https://github.com/${siteConfig.editPost.repo}/delete/main/src/config/moments/${m.fileName}`}
          >
            <Icon
              name="fluent:delete-12-regular"
              class="text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300 transition-all"
            />
          </a>
        </div>
      ))
    }
  </div>

  <!-- Tab switch script -->
  <script type="module">
    const buttons = document.querySelectorAll("#dashboard-tabs button");
    const sections = document.querySelectorAll(".tab-section");

    // Read last active tab from localStorage, default to "posts"
    let activeTab = localStorage.getItem("dashboardActiveTab") || "posts";

    // Show the correct section and button opacity
    sections.forEach(
      (s) => (s.style.display = s.id === "tab-" + activeTab ? "flex" : "none")
    );
    buttons.forEach(
      (b) => (b.style.opacity = b.dataset.tab === activeTab ? "1" : "0.6")
    );

    // Add click events
    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        activeTab = btn.dataset.tab;

        // Save the current tab to localStorage
        localStorage.setItem("dashboardActiveTab", activeTab);

        sections.forEach(
          (s) =>
            (s.style.display = s.id === "tab-" + activeTab ? "flex" : "none")
        );
        buttons.forEach(
          (b) => (b.style.opacity = b.dataset.tab === activeTab ? "1" : "0.6")
        );
      });
    });
  </script>
</MainGridLayout>
